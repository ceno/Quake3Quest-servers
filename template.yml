AWSTemplateFormatVersion: 2010-09-09
Description: ioquake3 server on port 27960
Parameters:
  AmiAlias:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-minimal-hvm-arm64-ebs
    Description: >-
      The actual AMI id ami-xxxxx will be dereferenced based on this alias.
      Default is "Amazon Linux 2 minimal HVM"
  VpcId:
    Type: 'AWS::EC2::VPC::Id'
    Description: >-
      VpcId of your Virtual Private Cloud.  You probably just have one default
      VPC.  Choose it here.
    ConstraintDescription: Must be the VPC Id of an existing Virtual Private Cloud.
  Subnets:
    Type: 'List<AWS::EC2::Subnet::Id>'
    Description: Choose a subnet for the instance.
  KeyName:
    Type: 'AWS::EC2::KeyPair::KeyName'
    Description: >-
      Choose a Key Pair for this instance.  If you do not have one, go make one
      in the EC2 section and it will appear here.
  BucketName:
    Type: 'String'
    Description: >-
      Bucket to hold all the pak files etc. Put region in the name, as a reminder
      that cross region transfer costs do apply so a bucket per region is most
      cost effective.
  Server0Name:
    Type: 'String'
    Description: >-
      Hostname for server on port 27960. Only the first 20 chars show up in the quake3 UI. OPTIONAL - leaving it empty will not start the server
  Server1Name:
    Type: 'String'
    Description: >-
      Hostname for server on port 27961. Only the first 20 chars show up in the quake3 UI. OPTIONAL - leaving it empty will not start the server
  RconPassword:
    Type: 'String'
    Description: >-
      Password to access server using RCON
  ProwlApiToken:
    Type: 'String'
    Description: >-
      OPTIONAL: Password for the prowl notification service (https://www.prowlapp.com/), which sends push notifications to iOS devices. May be left empty and the functionality will be skipped entirely
Resources:
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref BucketName
  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: >-
        Security Group that allows access to SSH connections and the quake3 server
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp:  0.0.0.0/0
        - IpProtocol: udp
          FromPort: 27960
          ToPort: 27962
          CidrIp:  0.0.0.0/0
  ElasticIp:
    Type: AWS::EC2::EIP
  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties: 
      Path: /
      Roles: 
       - !Ref Ec2InstanceRole
  Ec2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
  InstanceS3Policy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub ${BucketName}-list-and-get-objects
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Action:
              - s3:GetObject
              - s3:ListBucket
            Resource:
              - !Sub arn:aws:s3:::${BucketName}/*
              - !Sub arn:aws:s3:::${BucketName}
      Roles:
        -
          !Ref Ec2InstanceRole
  InstanceEIpPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: allocate-elastic-ips
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Action:
              - ec2:DescribeAddresses
              - ec2:AllocateAddress
              - ec2:DescribeInstances
              - ec2:AssociateAddress
            Resource: '*'
      Roles:
        -
          !Ref Ec2InstanceRole
  AutoScalingGroup:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      VPCZoneIdentifier: !Ref Subnets
      DesiredCapacity: 0
      MinSize: 0
      MaxSize: 1
      MixedInstancesPolicy:
        InstancesDistribution:
          OnDemandBaseCapacity: 0
          OnDemandPercentageAboveBaseCapacity: 0
          SpotAllocationStrategy: lowest-price
          # This allows up to 6 instance types across 3 AZs (3*6=18)
          SpotInstancePools: 20
        LaunchTemplate:
          LaunchTemplateSpecification: 
            LaunchTemplateId: !Ref LaunchTemplate
            Version: !GetAtt LaunchTemplate.LatestVersionNumber
          Overrides:
            - InstanceType: t4g.nano
            - InstanceType: t4g.micro
      Tags:
        - Key: Name
          Value: Quake3Quest
          PropagateAtLaunch: "true"
  LaunchTemplate:
    Type: 'AWS::EC2::LaunchTemplate'
    Metadata:
      AWS::CloudFormation::Init:
        config:
          files :
            /home/ec2-user/README.md:
              content: !Sub |
                Useful commands:

                sudo less /var/log/cloud-init-output.log
                sudo tail -f /var/log/cloud-init-output.log

                cat /run/systemd/system/quake3@.service
                systemctl status quake3@0
                journalctl -f -u quake3@0

                Config files:
                cat /opt/ioquake3/baseq3/autoexec.cfg
                cat /opt/ioquake3/baseq3/server0.cfg
                cat /opt/ioquake3/baseq3/server1.cfg
                cat /opt/ioquake3/baseq3/ctf.cfg
                cat /opt/ioquake3/baseq3/1x1.cfg
                cat /opt/ioquake3/baseq3/demo.cfg
                cat /opt/ioquake3/baseq3/custom.cfg
                cat /opt/ioquake3/baseq3/custom2.cfg
                cat /opt/ioquake3/baseq3/custom3.cfg
                cat /opt/ioquake3/baseq3/custom4.cfg
                cat /opt/ioquake3/baseq3/custom5.cfg

                RCON:
                icecon 127.0.0.1:27960 "${RconPassword}"
                ssh ec2-user@${ElasticIp} icecon 127.0.0.1:27960 "${RconPassword}"

                Quake rcon commands:
                status
                exec ctf.cfg
                addbot sarge 4 //that last number is the skill level [1-5]. e.g. doom, bones, slash, orbb, keel
                kick 2         //see status for number for each player
                kickbots       //kicks all bots
                vstr d1        //begin map rotation starting with d1 to d19
                map q3dm17
                map_restart
                timelimit 5
                fraglimit 20
                set bot_minplayers 3 //fills gamer list up to this number with bots

                Map list
                - http://www.bosskey.net/q3a/maps/standard.html

                Official ioquake3 admin guide
                - https://ioquake3.org/help/sys-admin-guide/#rcon

                Reference server.cfg
                - https://github.com/MarioVilas/ioquake3-server-docker/blob/master/q3a/baseq3/server.cfg
            /opt/ioquake3/baseq3/autoexec.cfg:
              content: !Sub |
                // This script is automatically run when the server starts.
                // 1. Engine setings
                set vm_game 2
                set vm_cgame 2
                set vm_ui 2
                seta rate "12400"
                seta snaps "40"
                seta cl_packetdup "1"
                set com_hunkmegs 256                     // maximum RAM used by the server
                
                // 2. Server settings
                // Note: net_port and sv_hostname are set in separate cfgs to enable multiple servers per machine
                //
                set sv_master1 "13.36.227.32:27950"      // default is master.ioquake3.org
                set sv_master2 ""                        // default is master.ioquake3.org
                set dedicated 2                          // 1: dedicated server, but not announced | 2: dedicated server, announced
                set sv_pure 0                            // 1: pure server, no altered pk3 files
                set g_log ""                             // log file name
                set logfile 0                            // 0:off 1:buffered 2:continuous 3:append to existing
                set sv_allowDownload 1                   // enables downloading maps from server. Requires clientside config. See https://openarena.fandom.com/wiki/Manual/Automatic_downloading
                set sv_dlURL ""                          // Tell clients to download pk3s from this URL instead of this server. Empty means use this server.
                set sv_dlRate 4096                       // Maximum download rate offered to clients (kb/s)
                set rconpassword "${RconPassword}"
                sets g_needpass 0                        // To set a password set this to 1, and uncomment the sets below
                //sets g_password "my-password"
                
                // 3. Game settings (common across all modes)
                //
                set sv_maxclients 8                      // max. number of clients than can connect
                set g_motd "Enter the Slaughter-Verse!"
                set g_allowvote 1                        // allow players to vote for map changes
                set timelimit 0                          // time limit in minutes for all modes (0 for no limit)
                // Weapon settings
                set g_weaponrespawn 5                    // weapon respawn in seconds
                set g_inactivity 120                     // kick players after being inactive (in seconds)
                set g_forcerespawn 0                     // 0:player has to press primary button to respawn
                // Bot settings
                set bot_enable 1                         // allow bots on the server
                set bot_nochat 1                         // 1: disable bot chatting (recommended!)
                set g_spskill 4                          // default skill of bots [1-5]
                set bot_minplayers 0                     // fills the server with bots to satisfy the minimum
            /opt/ioquake3/baseq3/server0.cfg:
              content: !Sub |
                set sv_hostname "${Server0Name}"
                set net_port 27960
                exec varied.cfg
            /opt/ioquake3/baseq3/server1.cfg:
              content: !Sub |
                set sv_hostname "${Server1Name}"
                set net_port 27961
                exec demo.cfg
            /opt/ioquake3/baseq3/stress.cfg:
              content: !Sub |
                // Useful config options when stress testing the server.
                // These facilitate upping player numbers by joining from PC clients and leaving them idle
                set g_inactivity 0                       // do not kick inactive users
                set g_forcerespawn 1                     // auto respawn
            /opt/ioquake3/baseq3/standard.cfg:
              content: !Sub |
                set g_gametype 0                    //  0       Free for all
                set fraglimit 20                    // frag limit for all modes (0 for no limit)
                set d1 "map q3dm7 ; set nextmap vstr d2"
                set d2 "map q3dm17 ; set nextmap vstr d3"
                set d3 "map q3dm6 ; set nextmap vstr d4"
                set d4 "map q3dm15 ; set nextmap vstr d1"
                
                vstr d1                             // load first map in rotation
            /opt/ioquake3/baseq3/ctf.cfg:
              content: !Sub |
                set g_gametype 4                    //  0       Capture the Flag
                set capturelimit 8                  // capture limit for CTF mode (0 for no limit)
                set g_teamAutoJoin 1                // 0:goes into spectator mode, 1:auto joins a team
                set g_teamForceBalance 1            // 0:free selection, 1:forces player to join weak team
                set g_friendlyFire 1                // 1: friendly fire allowed in CTF mode

                set c1 "map q3ctf1 ; set nextmap vstr c2"
                set c2 "map q3ctf2 ; set nextmap vstr c3"
                set c3 "map q3ctf4 ; set nextmap vstr c1"
                vstr c1                             // load first map in rotation
            /opt/ioquake3/baseq3/1x1.cfg:
              content: !Sub |
                set g_gametype 0                    //  0       Free for all
                set fraglimit 10
                set d1 "map Q3DM2 ; set nextmap vstr d2"
                set d2 "map Q3DM3 ; set nextmap vstr d3"
                set d3 "map Q3DM4 ; set nextmap vstr d4"
                set d4 "map Q3DM5 ; set nextmap vstr d5"
                set d5 "map Q3TOURNEY3 ; set nextmap vstr d6"
                set d6 "map Q3TOURNEY5 ; set nextmap vstr d7"
                set d7 "map Q3TOURNEY6 ; set nextmap vstr d1"
                vstr d1                             // load first map in rotation
            /opt/ioquake3/baseq3/demo.cfg:
              content: !Sub |
                set g_gametype 0
                set fraglimit 20                    // frag limit for all modes (0 for no limit)
                set d1 "map q3dm7 ; set nextmap vstr d2"
                set d2 "map q3dm17 ; set nextmap vstr d3"
                set d3 "map q3tourney2 ; set nextmap vstr d1"
                vstr d1
            /opt/ioquake3/baseq3/varied.cfg:
              content: !Sub |
                set g_gametype 0
                set fraglimit 20                    // frag limit for all modes (0 for no limit)
                set d1 "map q3dm4 ; set nextmap vstr d2"
                set d2 "map q3dm5 ; set nextmap vstr d3"
                set d3 "map q3dm6 ; set nextmap vstr d4"
                set d4 "map q3dm7 ; set nextmap vstr d5"
                set d5 "map q3dm8 ; set nextmap vstr d6"
                set d6 "map q3dm9 ; set nextmap vstr d7"
                set d7 "map q3dm13 ; set nextmap vstr d8"
                set d8 "map q3dm14 ; set nextmap vstr d9"
                set d9 "map q3dm15 ; set nextmap vstr d10"
                set d10 "map q3dm16 ; set nextmap vstr d11"
                set d11 "map q3dm17 ; set nextmap vstr d1"
                vstr d1
            /opt/ioquake3/baseq3/custom.cfg:
              content: !Sub |
                set g_gametype 0
                set fraglimit 20
                set d1 "map hub3aeroq3 ; set nextmap vstr d2"   // https://ws.q3df.org/map/hub3aeroq3/
                set d2 "map hub3tourney1 ; set nextmap vstr d3" // https://ws.q3df.org/map/hub3tourney1/
                set d3 "map cpm1a ; set nextmap vstr d4"        // https://ws.q3df.org/map/cpm1a
                set d4 "map ztn3dm1 ; set nextmap vstr d5"      // https://ws.q3df.org/map/ztn3dm1/
                set d5 "map alkdm06 ; set nextmap vstr d6"      // https://ws.q3df.org/map/alkdm06/
                set d6 "map bal3dm3 ; set nextmap vstr d1"      // https://ws.q3df.org/map/bal3dm3/
                vstr d1
            /opt/ioquake3/baseq3/custom2.cfg:
              content: !Sub |
                // Custom set of maps for experimentation
                set g_gametype 0
                set fraglimit 20
                set d1 "map hub3aeroq3 ; set nextmap vstr d2"     // https://ws.q3df.org/map/hub3aeroq3/
                set d2 "map hub3tourney1 ; set nextmap vstr d3"   // https://ws.q3df.org/map/hub3tourney1/
                set d3 "map cpm1a ; set nextmap vstr d4"          // https://ws.q3df.org/map/cpm1a
                set d4 "map ztn3dm1 ; set nextmap vstr d5"        // https://ws.q3df.org/map/ztn3dm1/
                set d5 "map alkdm06 ; set nextmap vstr d6"        // https://ws.q3df.org/map/alkdm06/
                set d6 "map bal3dm3 ; set nextmap vstr d7"        // https://ws.q3df.org/map/bal3dm3/
                set d7 "map simetrik ; set nextmap vstr d8"       // https://ws.q3df.org/map/simetrik/
                set d8 "map klzdeadly ; set nextmap vstr d9"      // https://ws.q3df.org/map/klzdeadly/
                set d9 "map charon3dm8 ; set nextmap vstr d10"    // https://ws.q3df.org/map/charon3dm8/
                set d10 "map auh3dm1; set nextmap vstr d11"       // https://ws.q3df.org/map/auh3dm1/
                set d11 "map mksteel; set nextmap vstr d12"       // https://ws.q3df.org/map/mksteel/
                set d12 "map akutatourney6; set nextmap vstr d13" // https://ws.q3df.org/map/akutatourney6/
                set d13 "map akutatourney8; set nextmap vstr d14" // https://lvlworld.com/media/id:2362
                set d14 "map akutadm1; set nextmap vstr d15"      // https://ws.q3df.org/map/akutadm1/
                set d15 "map akutadm2; set nextmap vstr d16"      // https://ws.q3df.org/map/akutadm2/
                set d16 "map akutadm3; set nextmap vstr d17"      // https://ws.q3df.org/map/akutadm3/
                set d17 "map charonq2dm1v2; set nextmap vstr d18" // https://ws.q3df.org/map/charonq2dm1v2/
                set d18 "map tabd2map01; set nextmap vstr d1"     // https://ws.q3df.org/map/tabd2map01/
                vstr d1
            /opt/ioquake3/baseq3/custom3.cfg:
              content: !Sub |
                // 'LvL Pack - The cream off the top' from https://lvlworld.com/review/id:664
                set g_gametype 0
                set fraglimit 20
                set d1 "map natedm2 ; set nextmap vstr d2"       // https://lvlworld.com/review/id:482
                set d2 "map ik3dm1 ; set nextmap vstr d3"        // https://lvlworld.com/review/id:20
                set d3 "map JAPANDM ; set nextmap vstr d4"       // https://lvlworld.com/review/id:44
                set d4 "map mrcq3t3 ; set nextmap vstr d5"       // https://lvlworld.com/review/id:428
                set d5 "map ztn3dm2 ; set nextmap vstr d6"       // https://lvlworld.com/review/id:107
                set d6 "map lun3dm2 ; set nextmap vstr d7"       // https://lvlworld.com/review/id:423
                set d6 "map bal3dm2 ; set nextmap vstr d7"       // https://lvlworld.com/review/id:429
                set d7 "map ztn3dm1 ; set nextmap vstr d8"       // https://lvlworld.com/review/id:203
                set d8 "map auh3dm2 ; set nextmap vstr d9"       // https://lvlworld.com/review/id:501
                set d9 "map shortcircuit ; set nextmap vstr d10" // https://lvlworld.com/review/id:494
                set d10 "map cpm8 ; set nextmap vstr d11"        // https://lvlworld.com/review/id:525
                set d11 "map auh3dm1 ; set nextmap vstr d12"     // https://lvlworld.com/review/id:614
                set d12 "map fff ; set nextmap vstr d13"         // https://lvlworld.com/review/id:551
                set d13 "map devdm3 ; set nextmap vstr d14"      // https://lvlworld.com/review/id:591
                set d14 "map d3xf1 ; set nextmap vstr d15"       // https://lvlworld.com/review/id:663
                set d15 "map tig_den ; set nextmap vstr d1"      // https://lvlworld.com/review/id:307
                vstr d1
            /opt/ioquake3/baseq3/custom4.cfg:
              content: !Sub |
                // 'LvL & PlanetQuake Pack 2: The Top Peg' from https://lvlworld.com/download/id:929
                // KtSdm3 (aka H2SO4) missing due to performance problems
                set g_gametype 0
                set fraglimit 20
                set lvlpq1 "map yog3dm2 ; set nextmap vstr lvlpq2"         // https://lvlworld.com/review/id:585
                set lvlpq2 "map bal3dm3 ; set nextmap vstr lvlpq3"         // https://lvlworld.com/review/id:670
                set lvlpq3 "map alkdm06 ; set nextmap vstr lvlpq4"         // https://lvlworld.com/review/id:689
                set lvlpq4 "map cpm1a ; set nextmap vstr lvlpq5"           // https://lvlworld.com/review/id:701
                set lvlpq5 "map cpm11 ; set nextmap vstr lvlpq6"           // https://lvlworld.com/review/id:766
                set lvlpq6 "map qxtourney1 ; set nextmap vstr lvlpq7"      // https://lvlworld.com/review/id:784
                set lvlpq7 "map saiko_tourney1a ; set nextmap vstr lvlpq8" // https://lvlworld.com/review/id:797
                set lvlpq8 "map hub3dm1 ; set nextmap vstr lvlpq9"         // https://lvlworld.com/review/id:822
                set lvlpq9 "map hub3aeroq3 ; set nextmap vstr lvlpq10"     // https://lvlworld.com/review/id:836
                set lvlpq10 "map bal3dm4 ; set nextmap vstr lvlpq11"       // https://lvlworld.com/review/id:857
                set lvlpq11 "map unitooldm4 ; set nextmap vstr lvlpq1"     // https://lvlworld.com/review/id:869
                vstr lvlpq1
            /opt/ioquake3/baseq3/custom5.cfg:
              content: !Sub |
                // 'LvL Q3A - 20 Years' from https://lvlworld.com/review/id:2401
                // Some maps missing due to performance problems
                set g_gametype 0
                set fraglimit 20
                set d1 "map chiropteraDM ; set nextmap vstr d2"   // https://lvlworld.com/review/id:1243
                set d2 "map auh3dm1 ; set nextmap vstr d3"        // https://lvlworld.com/review/id:614
                set d3 "map d3xf1 ; set nextmap vstr d4"          // https://lvlworld.com/review/id:663
                set d4 "map ik3dm2 ; set nextmap vstr d5"         // https://lvlworld.com/review/id:994
                set d5 "map fr3dm1 ; set nextmap vstr d6"         // https://lvlworld.com/review/id:637
                set d6 "map jof3dm2 ; set nextmap vstr d7"        // https://lvlworld.com/review/id:1757
                set d7 "map focal_p132 ; set nextmap vstr d8"     // https://lvlworld.com/review/id:2084
                set d8 "map hub3dm1 ; set nextmap vstr d9"       // https://lvlworld.com/review/id:822
                set d9 "map hub3aeroq3a ; set nextmap vstr d1"  // https://lvlworld.com/review/id:1717
                vstr d1
            /run/systemd/system/quake3@.service:
              content: !Sub |
                [Unit]
                Description=Quake3@%i
                After=network.target
                
                [Service]
                User=ec2-user
                Type=simple
                ExecStart=/opt/ioquake3/ioq3ded.arm64 +exec server%i.cfg
                KillMode=process
                Restart=on-failure
                StandardOutput=null
                StandardError=null
                
                [Install]
                WantedBy=multi-user.target
            /etc/systemd/journald.conf:
              content: !Sub |
                [Journal]
                SystemMaxUse=50M
            /usr/bin/icecon:
              mode: '000755'
              source: 'https://github.com/icedream/icecon/releases/download/v1.0.0/icecon_linux_arm'
    Properties:
      LaunchTemplateData: 
        KeyName: !Ref KeyName
        IamInstanceProfile:
          Name: !Ref InstanceProfile
        ImageId: !Ref AmiAlias
        SecurityGroupIds:
          - !Ref InstanceSecurityGroup
        # This is meant to be overridden by the ASG
        InstanceType: t4g.nano
        # The option below is really important! It specifies the behaviour when the instance runs out of CPU credits
        CreditSpecification:
          CpuCredits: unlimited
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeType: gp3
              VolumeSize: 2
              DeleteOnTermination: true
              Encrypted: false
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash -xe
            # iOS push notification functionality
            trap 'error $? $LINENO' ERR
            trap 'success' EXIT
            error() {
              [ "${ProwlApiToken}" != "" ] && curl -k https://api.prowlapp.com/publicapi/add -F apikey=${ProwlApiToken} -F application="Quake3Quest" -F event="Error!" -F description="${Server0Name} has failed to boot. Error $1 occurred on line $2"
            }
            success() {
              [ "${ProwlApiToken}" != "" ] && curl -k https://api.prowlapp.com/publicapi/add -F apikey=${ProwlApiToken} -F application="Quake3Quest" -F event="Ready" -F description="${Server0Name} `systemctl status quake3@0 | head -n1` `systemctl status quake3@0 | grep Active`"
              [ "${ProwlApiToken}" != "" ] && curl -k https://api.prowlapp.com/publicapi/add -F apikey=${ProwlApiToken} -F application="Quake3Quest" -F event="Ready" -F description="${Server1Name} `systemctl status quake3@1 | head -n1` `systemctl status quake3@1 | grep Active`"
            }
            [ "${ProwlApiToken}" != "" ] && curl -k https://api.prowlapp.com/publicapi/add -F apikey=${ProwlApiToken} -F application="Quake3Quest" -F event="Boot" -F description="${Server0Name} `curl -s http://169.254.169.254/latest/meta-data/instance-type`/${AWS::Region}/${ElasticIp}:27960"

            # Begin actual OS initialisation
            yum install -y vim htop wget aws-cli aws-cfn-bootstrap
            /opt/aws/bin/cfn-init -s ${AWS::StackId} -r LaunchTemplate --region ${AWS::Region} || exit 1

            # Clean yum to free up 200MB of disk space
            yum clean all
            rm -rf /var/cache/yum

            # Associate elastic IP manually to avoid the need for a load balancer
            aws configure set region ${AWS::Region}
            aws ec2 associate-address --instance-id `curl http://169.254.169.254/latest/meta-data/instance-id` --allocation-id  `aws ec2 describe-addresses --public-ips ${ElasticIp} --query 'Addresses[0].AllocationId' --output text`

            # Download ioquake3 from s3, but do pak0 separately to increase likelihood of it not flaking out
            aws configure set default.s3.max_concurrent_requests 1
            aws s3 cp s3://${BucketName}/ /opt/ioquake3/ --exclude baseq3/pak0.pk3 --only-show-errors --recursive
            aws s3 cp s3://${BucketName}/baseq3/pak0.pk3 /opt/ioquake3/baseq3/pak0.pk3 --only-show-errors
            chmod +x /opt/ioquake3/ioq3ded.arm64

            # Restart journald so it picks up the 50M limit for log size
            systemctl restart systemd-journald

            # Start quake3 servers if a name for them has been passed in the params
            [ "${Server0Name}" != "" ] && systemctl enable --now quake3@0
            [ "${Server1Name}" != "" ] && systemctl enable --now quake3@1
Outputs:
  ElasticIp:
    Value: !Ref ElasticIp
    Description: The elastic IP to be associated with the instance
